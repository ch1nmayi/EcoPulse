{% extends 'app.html' %}

{% block content %}

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
            <div class="position-sticky pt-3">
                <aside>
                    <h2>User Info</h2>
                    {% if user %}
                    <ul class="nav flex-column">
                        <li class="nav-item">Name: {{ user[1] }}</li>
                        <li class="nav-item">Email: {{ user[2] }}</li>
                        <a class="btn btn-primary mt-3" href="/logout" role="button">Log out</a>
                        <a class="btn btn-primary mt-2" href="/settings" role="button">Settings</a>
                    </ul>
                    {% endif %}
                </aside>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="pt-3 pb-2 mb-3 border-bottom">
                <div id="alertsContainer"></div>
                <a href="/history" class="btn btn-info mt-3">Historical data</a>
            </div>

            <div class="row">
                <div class="col-12 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <canvas id="canvas"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <canvas id="canvas2"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <canvas id="pieChartCanvas"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <canvas id="consumptionChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-12 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <canvas id="consumptionChart2"></canvas>
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> <!-- Latest jQuery, no need for the slim version separately -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script> <!-- Latest Popper.js -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/js/bootstrap.min.js"></script> <!-- Bootstrap, ensure compatibility with your Bootstrap CSS -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Latest Chart.js, no need for the old 2.8.0 version -->
<script>
$(document).ready(function () {
    
    const config = {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: "Electricity",
                backgroundColor: 'rgb(255, 99, 132)',
                borderColor: 'rgb(255, 99, 132)',
                data: [],
                fill: false,
            }],
        },
        options: {
            responsive: true,
            title: {
                display: true,
                text: 'Creating Real-Time Charts with Flask'
            },
            tooltips: {
                mode: 'index',
                intersect: false,
            },
            hover: {
                mode: 'nearest',
                intersect: true
            },
            scales: {
                xAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        labelString: 'Time'
                    }
                }],
                yAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        labelString: 'Value'
                    }
                }]
            }
        }
    };

    const config2 = {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: "Water",
                backgroundColor: 'rgb(54, 162, 235)',
                borderColor: 'rgb(54, 162, 235)',
                data: [],
                fill: false,
            }],
        },
        options: {
            responsive: true,
            title: {
                display: true,
                text: 'Creating Real-Time Charts with Flask'
            },
            tooltips: {
                mode: 'index',
                intersect: false,
            },
            hover: {
                mode: 'nearest',
                intersect: true
            },
            scales: {
                xAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        labelString: 'Time'
                    }
                }],
                yAxes: [{
                    display: true,
                    scaleLabel: {
                        display: true,
                        labelString: 'Value'
                    }
                }]
            }
        }
    };

    

    

 // Initialize line charts
 const context = document.getElementById('canvas').getContext('2d');
 const lineChart = new Chart(context, config); 

 const context2 = document.getElementById('canvas2').getContext('2d');
 const lineChart2 = new Chart(context2, config2);


 // EventSource for the first line chart
 const source = new EventSource("/chart-data");
 source.onmessage = function (event) {
    console.log(event.data);
    const data = JSON.parse(event.data);
    updateChartData(lineChart, data);
 }

 // EventSource for the second line chart
 const source2 = new EventSource("/chart-data2");
 source2.onmessage = function (event) {
    const data = JSON.parse(event.data);
    updateChartData(lineChart2, data);
 }
 

 // Generic function to update chart data
 function updateChartData(chart, data) {
    if (chart.data.labels.length >= 20) {
        chart.data.labels.shift();
        chart.data.datasets.forEach((dataset) => {
            dataset.data.shift();
        });
    }
    chart.data.labels.push(data.time);
    chart.data.datasets.forEach((dataset) => {
        dataset.data.push(data.value);
    });
    chart.update();


    fetch('/Detailed_electricity_data')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('consumptionChart').getContext('2d');
            const consumptionChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Electricity Consumption by Category',
                        data: Object.values(data),
                        backgroundColor: [
                            // Define colors for each slice
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(155, 93, 162, 0.2)',
                            'rgba(34, 172, 285, 0.2)',
                            'rgba(275, 56, 86, 0.2)',
                        ],
                        borderColor: [
                            // Define border colors for each slice
                            'rgba(255,99,132,1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(245,100,152,12)',
                            'rgba(54, 152, 245, 41)',
                            'rgba(265, 256, 36, 31)',
                            // Add more border colors for each category
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                }
            });
        });

        fetch('/Detailed_Water_data')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('consumptionChart2').getContext('2d');
            const consumptionChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(data),
                    datasets: [{
                        label: 'Water Consumption by Category',
                        data: Object.values(data),
                        backgroundColor: [
                            // Define colors for each slice
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(155, 93, 162, 0.2)',
                            'rgba(34, 172, 285, 0.2)',
                            'rgba(275, 56, 86, 0.2)',
                        ],
                        borderColor: [
                            // Define border colors for each slice
                            'rgba(255,99,132,1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(245,100,152,12)',
                            'rgba(54, 152, 245, 41)',
                            'rgba(265, 256, 36, 31)',
                            // Add more border colors for each category
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                }
            });
        });

    if (data.alert) {
        displayAlert(data);
    }


 }

 function displayAlert(data) {
    console.log("Displaying alert with data:", data);
    const container = document.getElementById('alertsContainer');
    container.innerHTML = ''; // This line clears any existing content in the alertsContainer.
    const alertDiv = document.createElement('div');
    alertDiv.classList.add('alert', 'alert-warning'); // Added alert-warning for Bootstrap styling
    alertDiv.innerText = `Alert at ${data.time}: High ${data.label} usage detected!`;
    container.appendChild(alertDiv); // Corrected variable name here
 }
 
 source.onmessage = function (event) {
    console.log(event.data); // Log the raw data received
    const data = JSON.parse(event.data);
    console.log(data); // Log the parsed data to check for the 'label' property
    updateChartData(lineChart, data);
}


 // Setup and update the pie chart
 const pieCtx = document.getElementById('pieChartCanvas').getContext('2d');
 const pieChart = new Chart(pieCtx, {
    type: 'pie',
    data: {
        labels: ['Electricity', 'Water'],
        datasets: [{
            backgroundColor: ['rgb(255, 99, 132)', 'rgb(54, 162, 235)'],
            data: [0, 0] // Initial data
        }]
    },
    options: {
        responsive: true,
        title: {
            display: true,
            text: 'Real-Time Pie Chart'
        },
    }
});

const pieSource = new EventSource("/pie-chart-data");
pieSource.onmessage = function (event) {
    const data = JSON.parse(event.data);
    pieChart.data.datasets[0].data = data.data;
    pieChart.update();
};



});


</script>
{% endblock %}